name: Handle PR Merge

on:
  pull_request:
    types: [closed]

jobs:
  update-issue:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            // Extract issue number from PR body (Closes #123)
            const issueMatch = body.match(/Closes\s+#(\d+)/i);
            const issueNumber = issueMatch ? issueMatch[1] : null;
            
            core.setOutput('issue-number', issueNumber);
            return { issueNumber };

      - name: Update issue labels and close
        if: steps.pr.outputs.issue-number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.pr.outputs.issue-number }}');
            
            // Remove "待审核" label and add "通过" label
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const labels = issue.data.labels.map(l => l.name);
            const labelsToRemove = labels.filter(l => l === '待审核');
            const labelsToAdd = ['通过'];
            
            // Remove old labels
            for (const label of labelsToRemove) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: label
              });
            }
            
            // Add new labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: labelsToAdd
            });
            
            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed'
            });

  handle-rejection:
    if: github.event.pull_request.merged == false && github.event.pull_request.state == 'closed'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const issueMatch = body.match(/Closes\s+#(\d+)/i);
            const issueNumber = issueMatch ? issueMatch[1] : null;
            core.setOutput('issue-number', issueNumber);

      - name: Update issue labels
        if: steps.pr.outputs.issue-number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.pr.outputs.issue-number }}');
            
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const labels = issue.data.labels.map(l => l.name);
            const labelsToRemove = labels.filter(l => l === '待审核');
            const labelsToAdd = ['拒绝'];
            
            for (const label of labelsToRemove) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: label
              });
            }
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: labelsToAdd
            });

