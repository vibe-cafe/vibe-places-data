name: Auto Issue Resolver

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: string

# Prevent concurrent runs for the same issue
concurrency:
  group: auto-resolver-${{ github.event.inputs.issue_number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  check-labels:
    runs-on: ubuntu-latest
    permissions:
      issues: read
      pull-requests: read
    outputs:
      should-process: ${{ steps.check.outputs.should-process }}
      issue-number: ${{ steps.check.outputs.issue-number }}
      issue-body: ${{ steps.check.outputs.issue-body }}
      issue-title: ${{ steps.check.outputs.issue-title }}
      issue-author-login: ${{ steps.check.outputs.issue-author-login }}
      issue-author-name: ${{ steps.check.outputs.issue-author-name }}
      issue-author-email: ${{ steps.check.outputs.issue-author-email }}
    steps:
      - name: Check if issue has required labels and no existing PR
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            // Get issue number from workflow_dispatch input or event
            const issueNumber = '${{ github.event.inputs.issue_number || github.event.issue.number }}';
            
            // Fetch issue details
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber)
            });
            
            const labels = issue.data.labels.map(l => l.name);
            const hasPendingReview = labels.includes('待审核');
            const hasNewPlace = labels.includes('新增地点');
            const hasUpdatePlace = labels.includes('更新地点');
            
            // Only process if BOTH required labels are present
            const hasRequiredLabels = hasPendingReview && (hasNewPlace || hasUpdatePlace);
            
            // Exit early if both labels don't exist (prevents duplicate workflow runs)
            if (!hasRequiredLabels) {
              console.log(`Issue #${issueNumber} does not have both required labels (need both "待审核" AND ("新增地点" OR "更新地点")), exiting early`);
              core.setOutput('should-process', 'false');
              core.setOutput('issue-number', issueNumber);
              core.setOutput('issue-body', issue.data.body || '');
              core.setOutput('issue-title', issue.data.title || '');
              core.setOutput('issue-author-login', '');
              core.setOutput('issue-author-name', '');
              core.setOutput('issue-author-email', '');
              return;
            }
            
            // Check if a PR already exists for this issue
            let hasExistingPR = false;
            if (hasRequiredLabels) {
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 100
              });
              
              // Check PR body for "Closes #issueNumber"
              const existingPR = prs.data.find(pr => {
                const body = pr.body || '';
                const issueMatch = body.match(/Closes\s+#(\d+)/i);
                return issueMatch && parseInt(issueMatch[1]) === parseInt(issueNumber);
              });
              
              if (existingPR) {
                console.log(`PR #${existingPR.number} already exists for issue #${issueNumber}, skipping`);
                hasExistingPR = true;
              }
            }
            
            // Only process if both labels are present AND no PR exists
            const shouldProcess = hasRequiredLabels && !hasExistingPR;
            core.setOutput('should-process', shouldProcess);
            core.setOutput('issue-number', issueNumber);
            core.setOutput('issue-body', issue.data.body || '');
            core.setOutput('issue-title', issue.data.title || '');
            
            // Set default outputs even if not processing (for workflow consistency)
            if (!shouldProcess) {
              core.setOutput('issue-author-login', '');
              core.setOutput('issue-author-name', '');
              core.setOutput('issue-author-email', '');
            }
            
            // Get issue author information for attribution
            if (shouldProcess && issue.data.user) {
              const author = issue.data.user;
              core.setOutput('issue-author-login', author.login);
              core.setOutput('issue-author-name', author.name || author.login);
              
              // Try to get user's public email, fallback to GitHub no-reply email
              try {
                const userDetails = await github.rest.users.getByUsername({
                  username: author.login
                });
                const email = userDetails.data.email || `${author.login}@users.noreply.github.com`;
                core.setOutput('issue-author-email', email);
              } catch (e) {
                // Fallback to GitHub no-reply email
                core.setOutput('issue-author-email', `${author.login}@users.noreply.github.com`);
              }
            }
            
            if (!hasRequiredLabels) {
              console.log(`Issue #${issueNumber} does not have required labels (need both "待审核" AND ("新增地点" OR "更新地点")), skipping`);
            } else if (hasExistingPR) {
              console.log(`Issue #${issueNumber} already has an open PR, skipping`);
            } else {
              console.log(`Issue #${issueNumber} has required labels and no existing PR, will process`);
            }

  process-issue:
    needs: check-labels
    if: needs.check-labels.outputs.should-process == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install axios

      - name: Process issue
        id: process
        env:
          # Use OpenRouter if available, otherwise OpenAI
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL || 'x-ai/grok-code-fast-1' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.check-labels.outputs.issue-number }}
          ISSUE_BODY: ${{ needs.check-labels.outputs.issue-body }}
          ISSUE_TITLE: ${{ needs.check-labels.outputs.issue-title }}
          ISSUE_AUTHOR_LOGIN: ${{ needs.check-labels.outputs.issue-author-login }}
          ISSUE_AUTHOR_NAME: ${{ needs.check-labels.outputs.issue-author-name }}
          ISSUE_AUTHOR_EMAIL: ${{ needs.check-labels.outputs.issue-author-email }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          node .github/scripts/process-issue.js

      - name: Create Pull Request
        if: steps.process.outputs.branch_name != '' && steps.process.outputs.error != 'true'
        id: create-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const branchName = '${{ steps.process.outputs.branch_name }}';
            const placeTitle = '${{ steps.process.outputs.place_title }}';
            const isUpdate = '${{ steps.process.outputs.is_update }}' === 'true';
            const issueNumber = ${{ needs.check-labels.outputs.issue-number }};
            const authorLogin = '${{ needs.check-labels.outputs.issue-author-login }}';
            
            const title = isUpdate ? `Update: ${placeTitle}` : `Add: ${placeTitle}`;
            
            // Build PR body with contributor attribution
            let body = isUpdate 
              ? `Updates place information for "${placeTitle}"\n\n`
              : `Adds new place: "${placeTitle}"\n\n`;
            
            // Add contributor attribution if available
            if (authorLogin) {
              body += `Contributed by @${authorLogin}\n\n`;
            }
            
            body += `Closes #${issueNumber}`;
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              head: branchName,
              base: 'main'
            });
            
            // Assign reviewer
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.data.number,
                reviewers: [context.repo.owner]
              });
            } catch (e) {
              console.warn('Failed to assign reviewer:', e.message);
            }
            
            core.setOutput('pr_number', pr.data.number.toString());
            return pr.data.number;

      - name: Comment on issue
        if: steps.create-pr.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.create-pr.outputs.pr_number }}';
            const issueNumber = ${{ needs.check-labels.outputs.issue-number }};
            const prUrl = `https://github.com/${{ github.repository }}/pull/${prNumber}`;
            
            github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ 已自动创建 Pull Request: #${prNumber}\n\n请查看并审核: ${prUrl}`
            });

      - name: Comment on error
        if: steps.process.outputs.error == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const errorMsg = `${{ steps.process.outputs.error_message }}`;
            const issueNumber = ${{ needs.check-labels.outputs.issue-number }};
            github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `❌ 处理问题时出错:\n\n\`\`\`\n${errorMsg}\n\`\`\`\n\n已通知维护者。`
            });

      - name: Notify maintainer on error
        if: steps.process.outputs.error == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const errorMsg = `${{ steps.process.outputs.error_message }}`;
            const issueNumber = ${{ needs.check-labels.outputs.issue-number }};
            const issueUrl = `https://github.com/${{ github.repository }}/issues/${issueNumber}`;
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Auto Resolver Error] Issue #${issueNumber}`,
              body: `处理 Issue #${issueNumber} 时出错:\n\n${errorMsg}\n\nIssue: ${issueUrl}`,
              labels: ['bug']
            });

