name: Auto Issue Resolver

run-name: ${{ github.event_name == 'workflow_dispatch' && format('[Manually] - Issue {0}{1}', '#', github.event.inputs.issue_number) || github.event.issue.title }}

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: string

# Prevent concurrent runs for the same issue
# When templates add multiple labels (e.g., ["待审核", "新增地点（截图）"]), GitHub fires separate events.
# The filter job ensures we only process when "待审核" is added, and concurrency prevents duplicate runs.
concurrency:
  group: auto-resolver-${{ github.event.inputs.issue_number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  # Filter job: Only process when STATE label "待审核" is added
  # This prevents runs when only type labels are added (e.g., if "新增地点（截图）" is added before "待审核")
  # Label structure:
  #   - Type labels (content type): '新增地点', '更新地点', '新增地点（截图）'
  #   - State labels (workflow state management): '待审核', '通过', '拒绝'
  # Protection layers:
  #   1. Filter job: Only runs when "待审核" label is added (not type labels)
  #   2. Concurrency group: Prevents multiple runs for same issue (cancels in-progress)
  #   3. Label validation: check-labels job verifies both labels exist before processing
  filter-label:
    if: github.event_name == 'workflow_dispatch' || github.event.label.name == '待审核'
    runs-on: ubuntu-latest
    steps:
      - name: Confirm state label check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Processing workflow via manual dispatch"
          else
            echo "Processing workflow for state label: ${{ github.event.label.name }}"
          fi

  check-labels:
    needs: filter-label
    # Verify that issue has required state label: '待审核' (already filtered above)
    runs-on: ubuntu-latest
    permissions:
      issues: read
      pull-requests: read
    outputs:
      should-process: ${{ steps.check.outputs.should-process }}
      issue-number: ${{ steps.check.outputs.issue-number }}
      issue-body: ${{ steps.check.outputs.issue-body }}
      issue-title: ${{ steps.check.outputs.issue-title }}
      issue-author-login: ${{ steps.check.outputs.issue-author-login }}
      issue-author-name: ${{ steps.check.outputs.issue-author-name }}
      issue-author-email: ${{ steps.check.outputs.issue-author-email }}
      issue-labels: ${{ steps.check.outputs.issue-labels }}
      is-screenshot: ${{ steps.check.outputs.is-screenshot }}
    steps:
      - name: Check required labels and collect issue data
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            // Get issue number from workflow_dispatch input or event
            const issueNumber = '${{ github.event.inputs.issue_number || github.event.issue.number }}';
            
            // Fetch issue details
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber)
            });
            
            const labels = issue.data.labels.map(l => l.name);
            
            // Define type labels and state labels
            const typeLabels = ['新增地点', '更新地点', '新增地点（截图）'];
            const stateLabels = ['待审核', '通过', '拒绝'];
            
            // Check for state label: '待审核' (required to trigger processing)
            const hasPendingReview = labels.includes('待审核');
            
            // Validate exactly one type label
            const typeLabelsFound = labels.filter(l => typeLabels.includes(l));
            if (typeLabelsFound.length === 0) {
              console.log(`Issue #${issueNumber} missing required type label (新增地点, 更新地点, or 新增地点（截图）) - skipping`);
              core.setOutput('should-process', 'false');
              core.setOutput('issue-number', issueNumber);
              core.setOutput('issue-body', issue.data.body || '');
              core.setOutput('issue-title', issue.data.title || '');
              core.setOutput('issue-author-login', '');
              core.setOutput('issue-author-name', '');
              core.setOutput('issue-author-email', '');
              core.setOutput('issue-labels', JSON.stringify(labels));
              core.setOutput('is-screenshot', 'false');
              return;
            }
            
            if (typeLabelsFound.length > 1) {
              console.log(`Issue #${issueNumber} has multiple type labels: ${typeLabelsFound.join(', ')} - skipping`);
              core.setOutput('should-process', 'false');
              core.setOutput('issue-number', issueNumber);
              core.setOutput('issue-body', issue.data.body || '');
              core.setOutput('issue-title', issue.data.title || '');
              core.setOutput('issue-author-login', '');
              core.setOutput('issue-author-name', '');
              core.setOutput('issue-author-email', '');
              core.setOutput('issue-labels', JSON.stringify(labels));
              core.setOutput('is-screenshot', 'false');
              return;
            }
            
            // Check for state label: '待审核' (required to trigger processing)
            if (!hasPendingReview) {
              console.log(`Issue #${issueNumber} does not have required state label "待审核" - skipping`);
              core.setOutput('should-process', 'false');
              core.setOutput('issue-number', issueNumber);
              core.setOutput('issue-body', issue.data.body || '');
              core.setOutput('issue-title', issue.data.title || '');
              core.setOutput('issue-author-login', '');
              core.setOutput('issue-author-name', '');
              core.setOutput('issue-author-email', '');
              core.setOutput('issue-labels', JSON.stringify(labels));
              core.setOutput('is-screenshot', 'false');
              return;
            }
            
            // Detect screenshot mode
            const isScreenshot = typeLabelsFound[0] === '新增地点（截图）';
            
            // Process if state label is present
            const shouldProcess = hasPendingReview;
            core.setOutput('should-process', shouldProcess);
            core.setOutput('issue-number', issueNumber);
            core.setOutput('issue-body', issue.data.body || '');
            core.setOutput('issue-title', issue.data.title || '');
            core.setOutput('issue-labels', JSON.stringify(labels));
            core.setOutput('is-screenshot', isScreenshot.toString());
            
            // Set default outputs even if not processing (for workflow consistency)
            if (!shouldProcess) {
              core.setOutput('issue-author-login', '');
              core.setOutput('issue-author-name', '');
              core.setOutput('issue-author-email', '');
            }
            
            // Get issue author information for attribution
            if (shouldProcess && issue.data.user) {
              const author = issue.data.user;
              core.setOutput('issue-author-login', author.login);
              core.setOutput('issue-author-name', author.name || author.login);
              
              // Try to get user's public email, fallback to GitHub no-reply email
              try {
                const userDetails = await github.rest.users.getByUsername({
                  username: author.login
                });
                const email = userDetails.data.email || `${author.login}@users.noreply.github.com`;
                core.setOutput('issue-author-email', email);
              } catch (e) {
                // Fallback to GitHub no-reply email
                core.setOutput('issue-author-email', `${author.login}@users.noreply.github.com`);
              }
            }
            
            if (!shouldProcess) {
              console.log(`Issue #${issueNumber} missing required state label - skipping`);
            } else {
              const mode = isScreenshot ? 'screenshot mode' : 'text mode';
              console.log(`Issue #${issueNumber} has required state label "待审核" - will process in ${mode}`);
            }

  process-issue:
    needs: check-labels
    if: needs.check-labels.outputs.should-process == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install axios @toon-format/toon

      - name: Process issue
        id: process
        env:
          # Use OpenRouter if available, otherwise OpenAI
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL || 'x-ai/grok-4.1-fast' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.check-labels.outputs.issue-number }}
          ISSUE_BODY: ${{ needs.check-labels.outputs.issue-body }}
          ISSUE_TITLE: ${{ needs.check-labels.outputs.issue-title }}
          ISSUE_AUTHOR_LOGIN: ${{ needs.check-labels.outputs.issue-author-login }}
          ISSUE_AUTHOR_NAME: ${{ needs.check-labels.outputs.issue-author-name }}
          ISSUE_AUTHOR_EMAIL: ${{ needs.check-labels.outputs.issue-author-email }}
          ISSUE_LABELS: ${{ needs.check-labels.outputs.issue-labels }}
          IS_SCREENSHOT: ${{ needs.check-labels.outputs.is-screenshot }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          node .github/scripts/process-issue.js

      - name: Create Pull Request
        if: steps.process.outputs.branch_name != '' && steps.process.outputs.error != 'true'
        id: create-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const branchName = '${{ steps.process.outputs.branch_name }}';
            const placeTitle = '${{ steps.process.outputs.place_title }}';
            const isUpdate = '${{ steps.process.outputs.is_update }}' === 'true';
            const issueNumber = ${{ needs.check-labels.outputs.issue-number }};
            const authorLogin = '${{ needs.check-labels.outputs.issue-author-login }}';
            
            const title = isUpdate ? `Update: ${placeTitle}` : `Add: ${placeTitle}`;
            
            // Build PR body with contributor attribution
            let body = isUpdate 
              ? `Updates place information for "${placeTitle}"\n\n`
              : `Adds new place: "${placeTitle}"\n\n`;
            
            // Add contributor attribution if available
            if (authorLogin) {
              body += `Contributed by @${authorLogin}\n\n`;
            }
            
            body += `Closes #${issueNumber}`;
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              head: branchName,
              base: 'main'
            });
            
            // Assign reviewer
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.data.number,
                reviewers: [context.repo.owner]
              });
            } catch (e) {
              console.warn('Failed to assign reviewer:', e.message);
            }
            
            core.setOutput('pr_number', pr.data.number.toString());
            return pr.data.number;

      - name: Comment on issue
        if: steps.create-pr.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.create-pr.outputs.pr_number }}';
            const issueNumber = ${{ needs.check-labels.outputs.issue-number }};
            const prUrl = `https://github.com/${{ github.repository }}/pull/${prNumber}`;
            
            github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ 已自动创建 Pull Request: #${prNumber}\n\n请查看并审核: ${prUrl}`
            });

      - name: Comment on error
        if: steps.process.outputs.error == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const errorMsg = `${{ steps.process.outputs.error_message }}`;
            const issueNumber = ${{ needs.check-labels.outputs.issue-number }};
            github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `❌ 处理问题时出错:\n\n\`\`\`\n${errorMsg}\n\`\`\`\n\n已通知维护者。`
            });

      - name: Notify maintainer on error
        if: steps.process.outputs.error == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const errorMsg = `${{ steps.process.outputs.error_message }}`;
            const issueNumber = ${{ needs.check-labels.outputs.issue-number }};
            const issueUrl = `https://github.com/${{ github.repository }}/issues/${issueNumber}`;
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Auto Resolver Error] Issue #${issueNumber}`,
              body: `处理 Issue #${issueNumber} 时出错:\n\n${errorMsg}\n\nIssue: ${issueUrl}`,
              labels: ['bug']
            });

